---

title: Writing and testing Linux kernel modules for Android
date: '2013-07-02T09:55:00.001+05:30'

tags:
- make
- ADB
- kernel
- linaro
- modules
- Android
- Compilers
modified_time: '2013-07-02T09:55:56.144+05:30'
blogger_id: tag:blogger.com,1999:blog-286864074933316179.post-4093668535588249461
blogger_orig_url: https://www.incrediblediy.com/2013/07/writing-and-testing-linux-kernel.html
---

We compiled and installed some modules in Linux kernel in <a href="http://www.incrediblediy.com/2013/06/compiling-kernel-modules-for-android.html">previous post</a>. Here I'm going to write my own kernel modules and do the same. I'm stilling learning about this and I was able to write and test a hello world kernel module on my phone.<br /><br /> Phone kernel : <a href="http://forum.xda-developers.com/showthread.php?t=2167119">Linux 2.6.32.60-Kappa1.6</a><br />PC O/S : <a href="http://www.ubuntu.com/download/desktop">Ubuntu 13.04 32bit</a><br />Cross compiler toolchain : <a href="https://launchpadlibrarian.net/129960680/gcc-linaro-arm-linux-gnueabihf-4.7-2013.01-20130125_linux.tar.bz2">Linaro GCC 4.7-2013.01</a><br /><br /><b><u>Prerequisite</u></b> <br /><br />1) Check for your kernel info using "<b>uname -a</b>" on either terminal emulator or <a href="http://developer.android.com/tools/help/adb.html%E2%80%8E">ADB</a> (use "<b>adb shell</b>" and run it).<br />My result:&nbsp; <b>Linux version 2.6.32.60-Kappa1.6 (Ka@Kappa) (gcc version  4.7.3 20130102 (prerelease) (Linaro GCC 4.7-2013.01) ) #94 PREEMPT Sun  Apr 28 23:46:13 CEST 2013</b><br /><br />2) Get the appropriate kernel source for your kernel. I got  2.6.32.60-Kappa1.6 kernel source from a GIT host using, (If you don't  have <b>git </b>installed, you can install it by <b>sudo apt-get install git</b>)<br /><b>git clone https://github.com/KaSt/Kappa.git</b><br />Now my kernel source is at <b> /home/buddika/kernel/Kappa/</b><br /><br />3) Download the appropriate cross-compiler toolchain, I'm using <a href="https://launchpadlibrarian.net/129960680/gcc-linaro-arm-linux-gnueabihf-4.7-2013.01-20130125_linux.tar.bz2">Linaro GCC 4.7-2013.01</a> toolchain.<br /><br />4) Extract toolchain to somewhere, I extracted it to, <b>/home/buddika/linaro</b><br /><br /><b><u>Coding</u></b><br /><br />I made a directory for my coding as <b>/home/buddika/modules</b><br />Please edit these codes to suite your environment. :)<b> </b><br /><br />1) hello.c<br /><blockquote class="tr_bq"><br />/*&nbsp; <br />&nbsp;*&nbsp; hello-1.c - The simplest kernel module.<br />&nbsp;*/<br />#include &lt;linux/module.h&gt;&nbsp;&nbsp;&nbsp; /* Needed by all modules */<br />#include &lt;linux/kernel.h&gt;&nbsp;&nbsp;&nbsp; /* Needed for KERN_INFO */<br /><br />int init_module(void)<br />{<br />&nbsp;&nbsp;&nbsp; printk(KERN_INFO "Hello world 1.\n");<br /><br />&nbsp;&nbsp;&nbsp; /* <br />&nbsp;&nbsp;&nbsp; &nbsp;* A non 0 return means init_module failed; module can't be loaded. <br />&nbsp;&nbsp;&nbsp; &nbsp;*/<br />&nbsp;&nbsp;&nbsp; return 0;<br />}<br /><br />void cleanup_module(void)<br />{<br />&nbsp;&nbsp;&nbsp; printk(KERN_INFO "Goodbye world 1.\n");<br />}</blockquote><br />2) Makefile<br /><br /><blockquote class="tr_bq">VERSION = 2<br />PATCHLEVEL = 6<br />SUBLEVEL = 32<br />EXTRAVERSION = .60Kappa-1.6<br /><br />KERNEL_DIR=/home/buddika/kernel/Kappa/<br /><br />obj-m := hello.o<br />PWD := $(shell pwd)<br />default:<br />&nbsp;&nbsp;&nbsp; $(MAKE) ARCH=arm CROSS_COMPILE=/home/buddika/linaro/bin/arm-linux-gnueabihf- -C $(KERNEL_DIR) SUBDIRS=$(PWD) modules<br />clean:<br />&nbsp;&nbsp;&nbsp; $(MAKE) -C $(KERNEL_DIR) SUBDIRS=$(PWD) clean</blockquote><br /><u><b>Building:</b></u><br /><br />Now in console execute following commands,<br /><b> </b><br /><b>cd </b><b>/home/buddika/modules</b><br /><b>make</b><br /><br />Now the kernel module hello.ko will be built at /home/buddika/modules<br /><br /><b><u>Testing:</u></b> <br /><br />I copied /home/buddika/modules/hello.ko my sdcard at /sdcard/mymod using (please make /sdcard/mymod directory before doing this)<br /><b>adb push /home/buddika/modules/hello.ko /sdcard/mymod/</b><br /><br />You can log into phone shell using<b> adb shell</b> and get root access using <b>su</b> at the shell.<br /><br />Let's load the module using,<br /><br /><b>insmod /sdcard/mymod/hello.ko</b><br /><br />You can check whether the module is loaded by using <b>lsmod </b>and check for output<b><br /></b><br /><br /><b>root@android:/ # lsmod<br />Module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp; Used by<br />hello&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 610&nbsp; 0 </b><br /><br /><br /><br />Run dmesg and check for line like this.If so you have written your first kernel module and loaded it successfully. :)<br /><br /><b>&lt;6&gt;[29913.944610] Hello world 1.</b><br /><br /><u>References:</u><br />1) <a href="http://www.tldp.org/LDP/lkmpg/2.6/html/x121.html">The Linux Kernel Module Programming Guide&nbsp;&nbsp;</a><br />2) <a class="posterName" href="http://forum.xda-developers.com/showpost.php?s=b05650e3e240883b3cf80f0b9209fc31&amp;p=17020258&amp;postcount=1">viulian</a><a href="http://forum.xda-developers.com/showpost.php?s=b05650e3e240883b3cf80f0b9209fc31&amp;p=17020258&amp;postcount=1">'s guide on xda-developers.com</a><br /><br /><br /><br />